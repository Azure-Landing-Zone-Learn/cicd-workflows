name: Trigger CI/CD Workflows

on:
  push:
    branches:
      - main

jobs:
  trigger-build-and-push:
    uses: Azure-Landing-Zone-Learn/cicd-workflows/.github/workflows/build-and-push.yml@main
    with:
      ACR_NAME: publicacrdmsnortheurope
      IMAGE_NAME: gettodo
      ACR_LOGIN_SERVER: publicacrdmsnortheurope.azurecr.io
    secrets: inherit

  trigger-install-and-deploy:
    needs: trigger-build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Verify script existence
        run: |
          echo "Listing files in the scripts directory:"
          ls -la ./scripts
          echo "Checking if deploy_acr_image.sh exists:"
          if [ -f ./scripts/deploy_acr_image.sh ]; then
            echo "Script found."
          else
            echo "Script not found!"
            exit 1
          fi

      - name: Run Deploy Script
        run: |
          echo "Running the deploy script..."
          az vm run-command invoke \
            --resource-group rg-dms-northeurope-001 \
            --vm-name vm-be-get-dms-northeurope \
            --command-id RunShellScript \
            --scripts "bash -s" < ./scripts/deploy_acr_image.sh
        env:
          ACR_NAME: publicacrdmsnortheurope
          ACR_LOGIN_SERVER: publicacrdmsnortheurope.azurecr.io
          IMAGE_NAME: gettodo
          IMAGE_TAG: latest
          CONTAINER_NAME: my_container
